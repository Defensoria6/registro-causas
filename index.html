<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Causas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{
      --bg:#a3c8ff; --card:#fff; --primary:#1f3a93; --accent:#3498db;
      --danger:#e74c3c; --success:#27ae60; --warning:#f39c12; --muted:#7f8c8d;
      --radius:12px; --shadow:0 4px 15px rgba(0,0,0,.08); --tag:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:var(--bg);color:#2c3e50;padding:20px}
    h1{margin:0 0 12px;color:var(--primary);text-align:center}
    .container{display:grid;grid-template-columns:1fr 340px;gap:20px;align-items:start}
    .main{min-width:0}
    .sidebar{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;position:sticky;top:14px}
    .sidebar h2{margin:0 0 10px;font-size:1.05rem;color:var(--accent);border-bottom:2px solid var(--accent);padding-bottom:6px}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:12px 0}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="text"], select.simple{padding:8px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;font-size:.9rem}
    .btn{border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:.92rem;transition:.2s;white-space:nowrap;line-height:1.2;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{opacity:.95}
    .btn:disabled{background:#ccc;cursor:not-allowed;opacity:.8}
    .btn i.fa-spin { animation: fa-spin 1.5s infinite linear; } /* Animaci√≥n para spinner */
    .btn-nuevo{background:var(--accent);color:#fff}
    .btn-print{background:var(--success);color:#fff}
    .btn-edit{background:var(--warning);color:#fff}
    .btn-delete{background:var(--danger);color:#fff}
    .btn-view{background:var(--primary);color:#fff}
    .btn-ghost{background:#eef2f7;color:#2c3e50}
    .table-wrap{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:.9rem;vertical-align:top;word-break:break-word}
    th{background:var(--primary);color:#fff;position:sticky;top:0;z-index:1}
    tr:hover td{background:#f9fbff}
    .nowrap{white-space:nowrap}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--tag);font-size:.75rem;margin-left:6px}
    .group{margin-bottom:12px}
    .event{display:flex;gap:8px;align-items:flex-start;background:#f9f9ff;border-left:4px solid var(--accent);padding:6px 8px;border-radius:6px;margin:6px 0}
    .event .when{font-weight:600}
    .k{color:#6b7280}
    #modal,#modalVer,#confirmModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;padding:20px;z-index:10}
    #modal .content,#modalVer .content,#confirmModal .content{background:#fff;border-radius:16px;max-width:980px;width:100%;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 8px 25px rgba(0,0,0,0.2);animation:fadeIn .25s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .modal-header{position:sticky;top:0;background:var(--primary);color:#fff;padding:12px 16px;font-size:1.1rem;font-weight:600;border-radius:16px 16px 0 0;z-index:5;display:flex;align-items:center;gap:10px;justify-content:center}
    .modal-body{padding:16px 16px 0;overflow-y:auto}
    .controls-form{position:sticky;bottom:0;background:#fff;padding:12px 16px;border-top:1px solid #eee;display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;z-index:5}
    #formCausa .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){ #formCausa .grid{grid-template-columns:1fr} .container{grid-template-columns:1fr} .sidebar{position:relative;top:auto} }
    #formCausa label{font-weight:600;color:var(--primary);font-size:0.9rem;margin-bottom:4px;display:block}
    #formCausa input,#formCausa textarea,#formCausa select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font-size:0.9rem;background:#fafafa;transition:.2s}
    #formCausa input:focus,#formCausa textarea:focus,#formCausa select:focus{outline:none;border-color:var(--accent);background:#fff}
    .counter{font-size:.8rem;color:#6b7280;margin-top:4px}
    #agregarNota{margin-top:20px;padding:15px;background:#f0f4f9;border:1px solid #ddd;border-radius:10px;}
    #agregarNota label{font-weight:600;color:var(--primary);display:block;margin-bottom:8px;}
    #agregarNota textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;resize:vertical;}
    #agregarNota button{background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;margin-top:10px;}
    #verContenido p{margin:.35rem 0;font-size:.92rem}
    #verContenido strong{color:var(--primary)}
    .note{border-left:3px solid #3498db;padding:6px;margin:6px 0;background:#f9fbff;border-radius:6px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .top-actions .actions .btn{display:flex;align-items:center}
    .prioridad-pill{display:inline-block;padding:4px 8px;border-radius:6px;font-size:0.8rem;font-weight:bold;color:#fff;text-transform:uppercase;}
    .prioridad-baja{background-color: var(--success);}
    .prioridad-media{background-color: var(--warning);}
    .prioridad-alta{background-color: var(--danger);}
    .prioridad-ninguna{background-color: var(--muted);}
    #confirmModal .content{max-width:400px;padding:24px;text-align:center;gap:16px;}
    #confirmModal h3{margin:0;color:var(--danger);font-size:1.5rem;}
    #confirmModal p{margin:0;color:var(--muted);font-size:0.95rem;}
    #confirmModal .actions-row{display:flex;justify-content:space-around;gap:12px;margin-top:20px;}
    #confirmModal .actions-row .btn{flex-grow:1;}
    .floating-alert{position:fixed;top:20px;left:50%;transform:translateX(-50%);background-color:var(--danger);color:#fff;padding:12px 24px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.2);z-index:1000;opacity:0;visibility:hidden;transition:opacity 0.3s ease-in-out, transform 0.3s ease-in-out;}
    .floating-alert.show{opacity:1;visibility:visible;transform:translateX(-50%) translateY(0);}
    .audiencias-container{margin-bottom:10px;}
    .audiencia-item{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
    .audiencia-item input{flex:1;}
    .btn-eliminar-audiencia{background:var(--danger);color:white;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;}
    .btn-audiencia{background:var(--success);color:white;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;margin-top:8px;}
    #paginacion-container{display:flex;justify-content:space-between;align-items:center;padding:10px;margin-top:15px;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);}
    #paginacion-container .page-info{font-size:0.9rem;color:var(--muted);font-weight:500;}
    #paginacion-container .nav-buttons{display:flex;gap:8px;}
  </style>
</head>
<body>
  <div class="floating-alert" id="floating-alert"></div>
  <div class="container">
    <div class="main">
      <div class="top-actions">
        <div class="filters">
          <input type="text" id="buscador" placeholder="üîç Buscar por N¬∞..." />
          <select id="filtroEstado" class="simple">
            <option value="">Estado (todos)</option>
            <option>En tr√°mite</option><option>Finalizado</option><option>En Alzada</option><option>Archivado</option>
          </select>
          <select id="filtroUsuario" class="simple">
            <option value="">Usuario (todos)</option>
          </select>
          <select id="filtroPrioridad" class="simple">
            <option value="">Prioridad (todas)</option>
            <option value="ninguna">Ninguna</option>
            <option value="baja">Baja</option>
            <option value="media">Media</option>
            <option value="alta">Alta</option>
          </select>
          <button id="btnLimpiarFiltros" class="btn btn-ghost"><i class="fa fa-eraser"></i> Limpiar</button>
        </div>
        <div class="actions">
          <button id="btnNuevo" class="btn btn-nuevo"><i class="fa fa-plus"></i>Nuevo Expediente</button>
          <button id="btnPrintListado" class="btn btn-print"><i class="fa fa-print"></i>Imprimir Listado</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="nowrap">N¬∞</th><th>Car√°tula</th><th>Tipo</th><th>Juzgado</th><th>Usuario</th><th>Estado</th><th>Prioridad</th><th class="nowrap">Registro</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyCausas"><tr><td colspan="9">Cargando...</td></tr></tbody>
        </table>
      </div>
      
      <div id="paginacion-container"></div>
    </div>

    <aside class="sidebar">
      <h2>üìÖ Pr√≥ximas Fechas (30 d√≠as)</h2>
      <div class="group"><div class="k">Audiencias <span class="pill" id="countAud">0</span></div><div id="listAud"></div></div>
      <div class="group"><div class="k">C√°mara Gesell <span class="pill" id="countGesell">0</span></div><div id="listGesell"></div></div>
      <div class="group"><div class="k">Vencimientos <span class="pill" id="countVenc">0</span></div><div id="listVenc"></div></div>
      <div class="group"><div class="k">Venc. de Recursos <span class="pill" id="countVrec">0</span></div><div id="listVrec"></div></div>
      <button id="btnPrintFechas" class="btn btn-print" style="margin-top:8px;width:100%"><i class="fa fa-print"></i>Imprimir Fechas</button>
    </aside>
  </div>

  <div id="modal">
    <div class="content">
      <div class="modal-header"><i class="fa-solid fa-file-pen"></i><h2 id="tituloForm" style="margin:0;">Nuevo Expediente</h2></div>
      <div class="modal-body">
        <form id="formCausa" action="#" method="post" aria-label="Formulario para nuevo expediente o edici√≥n">
          <input type="hidden" id="editId" />
          <div class="grid">
            <div class="field"><label for="numCausa">N¬∞ Expediente *</label><input id="numCausa" required autocomplete="off" /></div>
            <div class="field"><label for="caratula">Car√°tula Completa *</label><textarea id="caratula" rows="2" required></textarea></div>
            <div class="field"><label for="tipoProceso">Tipo de Proceso *</label><select id="tipoProceso" required></select></div>
            <div class="field"><label for="juzgado">Juzgado *</label><select id="juzgado" required></select></div>
            <div class="field"><label for="fechaInicio">Fecha de Inicio</label><input type="date" id="fechaInicio" /></div>
            <div class="field"><label for="fechaPase">Fecha de Pase</label><input type="datetime-local" id="fechaPase" /></div>
            <div class="field"><label for="intervencion">Intervenci√≥n</label><select id="intervencion"><option>Ministerio Complementario</option><option>Ministerio Principal</option><option>Patrocinante Actor</option><option>Patrocinante Demandado</option><option>Patrocinante Tercero</option><option value="Defensor de Ausente">Defensor de Ausente</option><option>Patrocinante presunto incapaz</option><option value="Defensor Oficial Asesor Letrado">Asesor Letrado</option><option>Ministerio P√∫blico del incapaz</option><option>Ministerio P√∫blico en turno Abril</option><option>Ministerio P√∫blico en turno Agosto</option><option>Ministerio P√∫blico en turno Diciembre</option></select></div>
            <div class="field"><label for="datosNnya">Datos de NNyA (m√°x. 500 palabras)</label><textarea id="datosNnya" disabled></textarea><div class="counter" id="counterNnya" style="display:none">0/500</div></div>
            <div class="field" style="grid-column:1/-1"><label for="audiencias">Audiencias se√±aladas</label><div id="audiencias-container" class="audiencias-container"></div><button type="button" id="btnAgregarAudiencia" class="btn-audiencia"><i class="fa fa-plus"></i> Agregar Audiencia</button></div>
            <div class="field"><label for="vencimiento">Vencimiento</label><input type="datetime-local" id="vencimiento" /></div>
            <div class="field"><label for="usuarioAsignado">Usuario Asignado</label><select id="usuarioAsignado"></select></div>
            <div class="field"><label for="estado">Estado del Proceso</label><select id="estado"><option>En tr√°mite</option><option>Finalizado</option><option>Archivado</option><option>En Alzada</option></select></div>
            <div class="field"><label for="prioridad">Prioridad</label><select id="prioridad" class="simple"><option value="ninguna">Ninguna (gris)</option><option value="baja">Baja (verde)</option><option value="media">Media (naranja)</option><option value="alta">Alta (roja)</option></select></div>
            <div class="field"><label for="recursos">Recursos Interpuestos</label><select id="recursos"><option value="">Seleccione un recurso</option><option>Apelaci√≥n</option><option>Queja</option><option>Inconstitucionalidad</option><option>Nulidad</option><option>Reposici√≥n</option><option>Aclaratoria</option><option>Recurso Extraordinario</option><option>Recurso de Inaplicabilidad</option></select></div>
            <div class="field"><label for="recursosContestacion">Recursos Contestaci√≥n</label><select id="recursosContestacion"><option value="">Seleccione un recurso</option><option>Apelaci√≥n</option><option>Queja</option><option>Inconstitucionalidad</option><option>Nulidad</option><option>Reposici√≥n</option><option>Aclaratoria</option><option>Recurso Extraordinario</option><option>Recurso de Inaplicabilidad</option></select></div>
            <div class="field"><label for="estadoRecursos">Estado de Recursos</label><select id="estadoRecursos"><option value="">Seleccione un estado</option><option>Pendiente</option><option>En tr√°mite</option><option>Resuelto</option><option>Rechazado</option></select></div>
            <div class="field"><label for="vencimientoRecursos">Vencimiento de Recursos</label><input type="datetime-local" id="vencimientoRecursos" /></div>
            <div class="field"><label for="audienciaGesell">Audiencia en C√°mara Gesell</label><div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="habilitarAudienciaGesell" /><span>Habilitar</span></div><input type="datetime-local" id="audienciaGesell" disabled /></div>
            <div class="field"><label for="nnyaGesell">NNyA en Gesell (m√°x. 400 palabras)</label><textarea id="nnyaGesell" disabled></textarea><div class="counter" id="counterNnyaGesell" style="display:none">0/400</div></div>
            <div class="field" style="grid-column:1/-1"><label for="observaciones">Observaciones (m√°x. 1000 palabras)</label><textarea id="observaciones" rows="3"></textarea><div class="counter" id="counter">0/1000</div></div>
          </div>
        </form>
      </div>
      <div class="controls-form">
        <button class="btn" type="button" id="btnGuardar"><i class="fa fa-save"></i>Guardar</button>
        <button class="btn-delete" type="button" id="btnEliminar"><i class="fa fa-trash"></i>Eliminar</button>
        <button class="btn-print" type="button" id="btnPrintForm"><i class="fa fa-print"></i>Imprimir</button>
        <button class="btn-ghost" type="button" id="btnCancelar"><i class="fa fa-times"></i>Cancelar</button>
      </div>
    </div>
  </div>
  <div id="modalVer">
    <div class="content">
      <div class="modal-header"><i class="fa-solid fa-eye"></i><h2 style="margin:0;">Detalle del Expediente</h2></div>
      <div class="modal-body"><div id="verContenido"></div><div id="agregarNota"><label for="notaBitacora">Agregar Nota de Seguimiento:</label><textarea id="notaBitacora" placeholder="Escribe aqu√≠ la nota..."></textarea><button id="btnAgregarNota"><i class="fa fa-plus"></i> Guardar Nota</button></div></div>
      <div class="controls-form" style="justify-content:flex-end;"><a href="https://defensoria6.github.io/linea-tiempo/" id="btnVerLineaTiempo" class="btn btn-view"><i class="fa-solid fa-timeline"></i> Ver L√≠nea de Tiempo</a><button id="btnCerrarVer" class="btn btn-ghost"><i class="fa fa-xmark"></i>Cerrar</button><button id="btnPrintRegistro" class="btn btn-print"><i class="fa fa-print"></i>Imprimir Registro</button></div>
    </div>
  </div>
  <div id="confirmModal">
    <div class="content">
      <h3>¬øEst√°s seguro?</h3><p>Esta acci√≥n eliminar√° el registro de forma permanente. No se puede deshacer.</p>
      <div class="actions-row"><button id="btnConfirmarEliminar" class="btn btn-delete"><i class="fa fa-trash"></i> Eliminar</button><button id="btnCancelarEliminar" class="btn btn-ghost"><i class="fa fa-xmark"></i> Cancelar</button></div>
    </div>
  </div>
  
  <script type="module">
  // ===== SDK MODULAR DE FIREBASE (v9+) =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, onSnapshot, query, where, orderBy, limit, limitToLast, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, startAfter, endBefore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
    authDomain: "causas-defensoria.firebaseapp.com",
    projectId: "causas-defensoria",
    storageBucket: "causas-defensoria.appspot.com",
    messagingSenderId: "186064671470",
    appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const causasCollection = collection(db, "causas");

  // ===== Helpers UI =====
  const $ = (id) => document.getElementById(id);
  const tbody = $("tbodyCausas"), modal = $("modal"), modalVer = $("modalVer"), confirmModal = $("confirmModal");
  const verContenido = $("verContenido"), tituloForm = $("tituloForm"), editId = $("editId");
  const buscador = $("buscador"), filtroEstado = $("filtroEstado"), filtroUsuario = $("filtroUsuario"), filtroPrioridad = $("filtroPrioridad");
  const listAud = $("listAud"), listGes = $("listGesell"), listVenc = $("listVenc"), listVrec = $("listVrec");
  const cAud = $("countAud"), cGes = $("countGesell"), cVenc = $("countVenc"), cVrec = $("countVrec");

  // ===== Estado de la Aplicaci√≥n =====
  let modo = "nuevo";
  let unsubCausas = null;
  let causaActualId = null;
  
  // ===== PAGINACI√ìN Y FILTROS (Servidor) =====
  const recordsPerPage = 10;
  let firstVisible = null, lastVisible = null, queryDirection = 'next', history = [];
  
  // ===== Utils =====
  const toDate = (v) => v?.toDate ? v.toDate() : (v?.seconds ? new Date(v.seconds * 1000) : (v ? new Date(v) : null));
  
  function formatearFecha(d, conHora = false) {
    const fecha = toDate(d);
    if (!fecha || isNaN(fecha)) return "";
    const dia = String(fecha.getDate()).padStart(2, '0');
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const a√±o = fecha.getFullYear();
    if (!conHora) return `${dia}/${mes}/${a√±o}`;
    const horas = String(fecha.getHours()).padStart(2, '0');
    const minutos = String(fecha.getMinutes()).padStart(2, '0');
    return `${dia}/${mes}/${a√±o} ${horas}:${minutos}`;
  }

  const prioridadClase = (p) => {
    p = (p || "ninguna").toLowerCase();
    if (p === "alta") return "prioridad-alta";
    if (p === "media") return "prioridad-media";
    if (p === "baja") return "prioridad-baja";
    return "prioridad-ninguna";
  };
  
  function debounce(func, delay) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  // ===== L√≥gica de carga de datos (Server-side filtering) =====
  function cargarCausas(conPaginacion = true) {
    if (unsubCausas) unsubCausas(); // Cancela la suscripci√≥n anterior

    tbody.innerHTML = `<tr><td colspan="9">Cargando...</td></tr>`;

    let q = query(causasCollection);

    // Aplicar filtros
    const est = filtroEstado.value;
    const usu = filtroUsuario.value;
    const prio = filtroPrioridad.value;
    const busq = buscador.value.trim();
    
    // Firestore requiere √≠ndices para consultas compuestas. La consola de Firebase te dar√° un enlace para crearlos.
    if (est) q = query(q, where("estado", "==", est));
    if (usu) q = query(q, where("usuarioAsignado", "==", usu));
    if (prio) q = query(q, where("prioridad", "==", prio));
    if (busq) {
      // B√∫squeda de prefijo simple en N¬∞ de Expediente
      q = query(q, where("numCausa", ">=", busq), where("numCausa", "<=", busq + '\uf8ff'));
    }
    
    // Aplicar orden y paginaci√≥n
    q = query(q, orderBy("fechaRegistro", "desc"));
    
    if (conPaginacion) {
        if (queryDirection === 'next' && lastVisible) {
            q = query(q, startAfter(lastVisible));
        } else if (queryDirection === 'prev' && firstVisible) {
            q = query(q, endBefore(firstVisible), limitToLast(recordsPerPage));
        }
    }
    
    q = query(q, limit(recordsPerPage));
    
    unsubCausas = onSnapshot(q, snap => {
        if (snap.empty) {
          tbody.innerHTML = "<tr><td colspan='9'>No hay registros que coincidan con los filtros.</td></tr>";
          renderPaginacion(0);
          return;
        }

        const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        firstVisible = snap.docs[0];
        lastVisible = snap.docs[snap.docs.length - 1];

        if (queryDirection === 'next') history.push(firstVisible);
        else if (queryDirection === 'prev' && history.length > 1) history.pop();

        renderTabla(data);
        renderPaginacion(data.length);

        if (history.length <= 1) {
            actualizarSidebarYFiltros();
        }
    }, err => {
        console.error("Error al cargar causas:", err);
        tbody.innerHTML = `<tr><td colspan='9'>Error al aplicar filtros. Es posible que necesites crear un √≠ndice en Firestore.</td></tr>`;
    });
  }

  // ===== Renderizado =====
  function accionesHTML(id) {
    return `<button class="btn-view" data-id="${id}" title="Ver"><i class="fa fa-eye"></i></button>
            <button class="btn-edit" data-id="${id}" title="Editar"><i class="fa fa-pen"></i></button>
            <button class="btn-delete" data-id="${id}" title="Eliminar"><i class="fa fa-trash"></i></button>
            <a href="https://defensoria6.github.io/linea-tiempo/?id=${id}" class="btn-view" title="Ver L√≠nea de Tiempo"><i class="fa-solid fa-timeline"></i></a>`;
  }

  function renderTabla(data) {
    let html = data.length ? "" : "<tr><td colspan='9'>No hay registros</td></tr>";
    data.forEach(d => {
      html += `
        <tr>
          <td class="mono">${d.numCausa || ""}</td>
          <td>${d.caratula || ""}</td>
          <td>${d.tipoProceso || ""}</td>
          <td>${d.juzgado || ""}</td>
          <td>${d.usuarioAsignado || ""}</td>
          <td>${d.estado || ""}</td>
          <td><span class="prioridad-pill ${prioridadClase(d.prioridad)}">${d.prioridad || "Ninguna"}</span></td>
          <td class="nowrap">${formatearFecha(d.fechaRegistro, false)}</td>
          <td class="nowrap actions">${accionesHTML(d.id)}</td>
        </tr>`;
    });
    tbody.innerHTML = html;
  }

  function renderPaginacion(recordsOnPage) {
    const container = $("paginacion-container");
    container.style.display = "flex";
    container.innerHTML = `
      <div class="page-info">Mostrando ${recordsOnPage} registros</div>
      <div class="nav-buttons">
        <button id="btnPrevPage" class="btn btn-ghost" ${history.length <= 1 ? 'disabled' : ''}><i class="fa fa-arrow-left"></i> Anterior</button>
        <button id="btnNextPage" class="btn btn-ghost" ${recordsOnPage < recordsPerPage ? 'disabled' : ''}>Siguiente <i class="fa fa-arrow-right"></i></button>
      </div>`;

    $("btnPrevPage").onclick = () => { queryDirection = 'prev'; cargarCausas(); };
    $("btnNextPage").onclick = () => { queryDirection = 'next'; cargarCausas(); };
  }

  // ===== Manejo de Filtros y Eventos =====
  const handleFilterChange = () => {
    firstVisible = null;
    lastVisible = null;
    history = [];
    queryDirection = 'next';
    cargarCausas();
  };

  buscador.addEventListener('input', debounce(handleFilterChange, 400));
  filtroEstado.onchange = handleFilterChange;
  filtroUsuario.onchange = handleFilterChange;
  filtroPrioridad.onchange = handleFilterChange;
  
  $("btnLimpiarFiltros").onclick = () => {
    buscador.value = "";
    filtroEstado.value = "";
    filtroUsuario.value = "";
    filtroPrioridad.value = "";
    handleFilterChange();
  };

  // Delegaci√≥n de eventos para la tabla
  tbody.addEventListener('click', (e) => {
    const targetButton = e.target.closest('button, a');
    if (!targetButton?.dataset?.id) return;
    const { id } = targetButton.dataset;

    if (targetButton.classList.contains('btn-view') && targetButton.tagName !== 'A') abrirVer(id);
    else if (targetButton.classList.contains('btn-edit')) abrirEditar(id);
    else if (targetButton.classList.contains('btn-delete')) abrirConfirmarEliminar(id);
  });

  // ===== Sidebar y Filtros (se actualizan con todos los datos) =====
  async function actualizarSidebarYFiltros() {
      const allDocsQuery = query(causasCollection, orderBy("fechaRegistro", "desc"));
      const snap = await getDocs(allDocsQuery);
      const allData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderSidebar(allData);
      poblarFiltroUsuarios(allData);
  }

  function renderSidebar(data){
    const hoy = new Date(), limite = new Date(hoy.getTime() + 30*24*60*60*1000);
    const eventos = {aud:[], ges:[], venc:[], vrec:[]};
    const pushIfRange = (arr, fecha, label) => { const f = toDate(fecha); if(f && f >= hoy && f <= limite) arr.push({f, label}); };
    data.forEach(d => {
        const id = d.numCausa || d.id;
        if (Array.isArray(d.audiencias)) d.audiencias.forEach(aud => pushIfRange(eventos.aud, aud, id));
        pushIfRange(eventos.ges, d.audienciaGesell, id);
        pushIfRange(eventos.venc, d.vencimiento, id);
        pushIfRange(eventos.vrec, d.vencimientoRecursos, `${id} ‚Äî ${d.recursos||'Recurso'}`);
    });
    const renderList = (arr, target, counterRef, empty) => {
      arr.sort((a,b) => a.f - b.f);
      counterRef.textContent = arr.length;
      target.innerHTML = arr.length ? arr.map(e => `<div class="event"><div class="when">${formatearFecha(e.f, true)}</div><div class="what">‚Äî ${e.label}</div></div>`).join('') : `<div class="k">${empty}</div>`;
    };
    renderList(eventos.aud, listAud, cAud, "No hay audiencias pr√≥ximas");
    renderList(eventos.ges, listGes, cGes, "No hay C√°maras Gesell pr√≥ximas");
    renderList(eventos.venc, listVenc, cVenc, "No hay vencimientos pr√≥ximos");
    renderList(eventos.vrec, listVrec, cVrec, "No hay venc. de recursos pr√≥ximos");
  }

  function poblarFiltroUsuarios(data){
    const set = new Set(data.map(d => d.usuarioAsignado).filter(Boolean));
    const current = filtroUsuario.value;
    filtroUsuario.innerHTML = `<option value="">Usuario (todos)</option>` + [...set].sort().map(u => `<option value="${u}">${u}</option>`).join('');
    filtroUsuario.value = current;
  }

  // ===== ABM Causas (con SDK v9+) =====
  $("btnNuevo").onclick = () => { 
    modo = "nuevo"; 
    resetFormCausa(); 
    editId.value = ""; 
    tituloForm.textContent = "Nuevo Expediente"; 
    modal.style.display = "flex"; 
  };

  $("btnGuardar").onclick = async () => {
    const datos = recolectarDatosForm();
    if (!datos.numCausa || !datos.caratula || !datos.tipoProceso || !datos.juzgado) { 
      return alert("Completa los campos obligatorios (N¬∞ Expediente, Car√°tula, Tipo y Juzgado).");
    }
    
    const btn = $("btnGuardar");
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> Guardando...`;

    try {
      if (modo === "nuevo") {
        const q = query(causasCollection, where("numCausa", "==", datos.numCausa));
        const snap = await getDocs(q);
        if (!snap.empty) {
          mostrarAlertaFlotante("Esta causa ya se encuentra registrada. Verifique el n√∫mero.");
          return;
        }
        await addDoc(causasCollection, { ...datos, fechaRegistro: serverTimestamp() });
      } else {
        await updateDoc(doc(db, "causas", editId.value), datos);
      }
      modal.style.display = "none";
    } catch(e) { 
      console.error(e); 
      alert("No se pudo guardar. Revisa la consola.");
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  };

  async function abrirEditar(id) {
    modo = "editar";
    resetFormCausa();
    editId.value = id;
    tituloForm.textContent = "Editar Expediente";
    try {
      const d = await getDoc(doc(db, "causas", id));
      if (d.exists()) {
        cargarDatosEnForm(d.data());
        modal.style.display = "flex";
      }
    } catch(e) {
      console.error(e);
      alert("No se pudo abrir el registro");
    }
  }

  function abrirConfirmarEliminar(id) {
    $("btnConfirmarEliminar").dataset.idToDelete = id;
    confirmModal.style.display = "flex";
  }

  $("btnConfirmarEliminar").onclick = async (e) => {
    const idToDelete = e.currentTarget.dataset.idToDelete;
    if (!idToDelete) return;
    try {
      await deleteDoc(doc(db, "causas", idToDelete));
      confirmModal.style.display = "none";
    } catch (e) {
      console.error("Error al eliminar:", e);
      alert("No se pudo eliminar el registro.");
    }
  };

  async function abrirVer(id) {
    causaActualId = id;
    try {
        const snap = await getDoc(doc(db, "causas", id));
        if (!snap.exists()) return alert("El expediente no fue encontrado.");
        
        const d = snap.data();
        let contenidoHTML = "";
        const etiquetas = { numCausa: "N¬∞ Expediente", caratula: "Car√°tula", tipoProceso: "Tipo de Proceso", juzgado: "Juzgado", fechaInicio: "Fecha de Inicio", fechaPase: "Fecha de Pase", intervencion: "Intervenci√≥n", datosNnya: "Datos de NNyA", vencimiento: "Vencimiento", usuarioAsignado: "Usuario Asignado", estado: "Estado", prioridad: "Prioridad", recursos: "Recursos Interpuestos", recursosContestacion: "Contestaci√≥n de Recursos", estadoRecursos: "Estado de Recursos", vencimientoRecursos: "Vencimiento de Recursos", audienciaGesell: "Audiencia Gesell", nnyaGesell: "NNyA en Gesell", observaciones: "Observaciones", fechaRegistro: "Fecha de Registro" };
        const ordenClaves = ["numCausa", "caratula", "tipoProceso", "juzgado", "estado", "prioridad", "usuarioAsignado", "fechaRegistro", "fechaInicio", "fechaPase", "intervencion", "datosNnya", "vencimiento", "audiencias", "recursos", "recursosContestacion", "estadoRecursos", "vencimientoRecursos", "audienciaGesell", "nnyaGesell", "observaciones"];
        
        ordenClaves.forEach(k => {
            const v = d[k];
            if (v !== null && v !== undefined && v !== "") {
                const etiqueta = etiquetas[k] || k;
                if (k === "audiencias" && Array.isArray(v) && v.length > 0) {
                    contenidoHTML += `<p><strong>Audiencias:</strong></p>` + v.map(aud => `<p style="margin-left: 20px;">${formatearFecha(aud, true)}</p>`).join('');
                } else if (['fechaInicio', 'fechaRegistro'].includes(k)) {
                    contenidoHTML += `<p><strong>${etiqueta}:</strong> ${formatearFecha(v, false)}</p>`;
                } else if (v.seconds) {
                    contenidoHTML += `<p><strong>${etiqueta}:</strong> ${formatearFecha(v, true)}</p>`;
                } else if (k !== "audiencias") {
                    contenidoHTML += `<p><strong>${etiqueta}:</strong> ${String(v).replace(/\n/g, '<br>')}</p>`;
                }
            }
        });

        verContenido.innerHTML = contenidoHTML;
        $("btnVerLineaTiempo").href = `https://defensoria6.github.io/linea-tiempo/?id=${id}`;
        modalVer.style.display = "flex";
    } catch(e) {
        console.error(e);
        alert("No se pudo abrir el detalle");
    }
  }

  // ===== L√≥gica del Formulario (sin cambios mayores) =====
  // (Las funciones de recolectarDatosForm, cargarDatosEnForm, initForm, etc., se mantienen casi id√©nticas)
  const juzgadosPorTipo = { Administrativo: ["CEJUME - Posadas","DEUT Defensorias - Posadas","Legajo Defensoria Civil y Comercial N¬∞ 6"], Civil: ["Juzgado Civil y Comercial N¬∞ 1 - Posadas","Juzgado Civil y Comercial N¬∞ 2 - Posadas","Juzgado Civil y Comercial N¬∞ 3 - Posadas","Juzgado Civil y Comercial N¬∞ 4 - Posadas","Juzgado Civil y Comercial N¬∞ 5 - Posadas","Juzgado Civil y Comercial N¬∞ 6 - Posadas","Juzgado Civil y Comercial N¬∞ 7 - Posadas","Juzgado Civil y Comercial N¬∞ 8 - Posadas","... Civil Comercial Laboral Familia y Violencia Fliar- Apostoles"], Penal: ["Juzgado de Instrucci√≥n N¬∞ 1 - Posadas","Juzgado de Instrucci√≥n N¬∞ 2 - Posadas","Juzgado de Instrucci√≥n N¬∞ 3 - Posadas","Juzgado de Instrucci√≥n N¬∞ 6 - Posadas","Juzgado de Instrucci√≥n N¬∞ 7 - Posadas","Juzgado Correccional y de Menores N¬∞ 1 - Posadas","Juzgado Correccional y de Menores N¬∞ 2 - Posadas","Tribunal Penal N¬∞ 1 - Posadas", "Tribunal Penal N¬∞ 2 - Posadas"], Laboral: ["Juzgado Laboral N¬∞ 1 - Posadas","Juzgado Laboral N¬∞ 2 - Posadas","Juzgado Laboral N¬∞ 3 - Posadas","Juzgado Laboral N¬∞ 4 - Posadas"], Familia: ["Juzgado de Familia N¬∞ 1 - Posadas","Juzgado de Familia N¬∞ 2 - Posadas","Juzgado de Familia N¬∞ 3 - Posadas","Juzgado Familia y VF Garupa", "... Civil Comercial Laboral Familia y Violencia Fliar- Apostoles"], "Violencia Familiar": ["Juzgado de Violencia Familiar N¬∞ 1 - Posadas","Juzgado de Violencia Familiar N¬∞ 2 - Posadas","Juzgado F y Violencia Familiar Garupa","... Civil Comercial Laboral Familia y Violencia Fliar- Apostoles"], Paz: ["Juzgado de Paz Civil Comercial N¬∞ 1 - Posadas","Juzgado de Paz Civil Comercial N¬∞ 2 - Posadas","Juzgado de Paz de Itaembe Mini - Posadas","Juzgado de Paz de Itaembe Guazu - Posadas","Juzgado de Paz de Villa Cabello - Posadas","Juzgado de Paz de Garupa","Juzgado de Paz de Fatima - Garupa","Juzgado de Paz de Apostoles","Juzgado de Paz Candelaria"] };
  const usuarios = ["Bazante Nadia Romina","Cardozo Maria Raquel","Cedron Noelia Aurora","Corrales Alicia Mariela","Escobar Monica Graciela","Fioravante Romulo","Gonzalez Alberto Misael","Gonzalez Juan Jose","Gudi√±o Natalia Esther","Magnani Enzo Luciano","Pablos Patricia","Palacios Ana Gabriela","Ramos Marcelo Gustavo","Riveros Patricia Soledad","Sosa Rita Cecilia"];
  const selTipo = $("tipoProceso"), selJuz = $("juzgado"), selUsu = $("usuarioAsignado");
  function initForm() {
    const tipos = Object.keys(juzgadosPorTipo);
    selTipo.innerHTML = tipos.map(t => `<option value="${t}">${t}</option>`).join('');
    selUsu.innerHTML = usuarios.map(u => `<option value="${u}">${u}</option>`).join('');
    selTipo.value = "Administrativo";
    actualizarJuzgados();
    toggleGesell(false);
    $("habilitarAudienciaGesell").checked = false;
  }
  function actualizarJuzgados() { const j = juzgadosPorTipo[selTipo.value] || []; selJuz.innerHTML = j.map(x => `<option value="${x}">${x}</option>`).join(''); }
  function toggleGesell(enabled) { const ag = $("audienciaGesell"), ng = $("nnyaGesell"), counter = $("counterNnyaGesell"); ag.disabled = !enabled; ng.disabled = !enabled; counter.style.display = enabled ? 'block' : 'none'; if (!enabled) { ag.value = ""; ng.value = ""; } }
  function resetFormCausa() { $("formCausa").reset(); initForm(); $("counter").textContent = "0/1000"; $("counterNnya").textContent = "0/500"; $("counterNnyaGesell").textContent = "0/400"; $("prioridad").value = "ninguna"; $("audiencias-container").innerHTML = ""; agregarAudiencia(); }
  function recolectarDatosForm() {
    const datos = {};
    const fields = ["numCausa", "caratula", "tipoProceso", "juzgado", "intervencion", "datosNnya", "usuarioAsignado", "estado", "prioridad", "recursos", "recursosContestacion", "estadoRecursos", "nnyaGesell", "observaciones"];
    fields.forEach(id => datos[id] = $(id).value || "");
    const dateFields = ["fechaInicio", "fechaPase", "vencimiento", "vencimientoRecursos", "audienciaGesell"];
    dateFields.forEach(id => datos[id] = $(id).value ? new Date($(id).value) : null);
    datos.audiencias = [...$("audiencias-container").querySelectorAll('input[type="datetime-local"]')].map(i => i.value ? new Date(i.value) : null).filter(Boolean);
    return datos;
  }
  function cargarDatosEnForm(d) {
      const formatFechaParaInput = (fecha, conHora = true) => { if (!fecha || isNaN(fecha)) return ""; const dt = new Date(fecha.getTime() - (fecha.getTimezoneOffset() * 60000)); return dt.toISOString().slice(0, conHora ? 16 : 10); };
      const setVal = (id, val) => { const el = $(id); if (el) el.value = val ?? ""; };
      initForm();
      if (d.tipoProceso) { selTipo.value = d.tipoProceso; actualizarJuzgados(); }
      Object.keys(d).forEach(k => {
          if (d[k]?.seconds) { setVal(k, formatFechaParaInput(toDate(d[k]), $(k)?.type === 'datetime-local')); } 
          else { setVal(k, d[k]); }
      });
      const audienciasContainer = $("audiencias-container");
      audienciasContainer.innerHTML = "";
      if (Array.isArray(d.audiencias) && d.audiencias.length > 0) {
          d.audiencias.forEach(aud => audienciasContainer.appendChild(crearAudienciaItem(formatFechaParaInput(toDate(aud), true))));
      } else { agregarAudiencia(); }
      const habilitar = !!(d.audienciaGesell || d.nnyaGesell);
      $("habilitarAudienciaGesell").checked = habilitar;
      toggleGesell(habilitar);
  }
  function crearAudienciaItem(value = "") { const item = document.createElement('div'); item.className = 'audiencia-item'; item.innerHTML = `<input type="datetime-local" value="${value}"><button type="button" class="btn-eliminar-audiencia"><i class="fa fa-trash"></i></button>`; item.querySelector('.btn-eliminar-audiencia').onclick = () => { if ($("audiencias-container").children.length > 1) item.remove(); else mostrarAlertaFlotante("Debe haber al menos una audiencia"); }; return item; }
  function agregarAudiencia() { $("audiencias-container").appendChild(crearAudienciaItem()); }
  $("btnAgregarAudiencia").onclick = agregarAudiencia;
  
  // ===== INICIALIZACI√ìN Y EVENTOS GLOBALES =====
  $("btnCancelarEliminar").onclick = () => confirmModal.style.display = "none";
  $("btnCerrarVer").onclick = () => modalVer.style.display = "none";
  $("btnCancelar").onclick = () => { if (confirm("¬øCancelar? Se perder√°n los cambios no guardados.")) modal.style.display = "none"; };
  $("habilitarAudienciaGesell").onchange = (e) => toggleGesell(e.target.checked);
  window.addEventListener("click", e => { if (e.target === modal || e.target === modalVer || e.target === confirmModal) e.target.style.display = "none"; });
  const printSection = (html) => { const w = window.open(); w.document.write(`<html><head><title>Imprimir</title></head><body>${html}</body></html>`); w.document.close(); w.print(); };
  $("btnPrintListado").onclick = () => printSection($("table").outerHTML);
  $("btnPrintFechas").onclick = () => printSection($("sidebar").innerHTML);
  $("btnPrintForm").onclick = () => printSection($("formCausa").outerHTML);
  $("btnPrintRegistro").onclick = () => printSection($("verContenido").outerHTML);
  function mostrarAlertaFlotante(mensaje) { const alert = $("floating-alert"); alert.textContent = mensaje; alert.classList.add("show"); setTimeout(() => alert.classList.remove("show"), 5000); }
  
  initForm();
  cargarCausas(); // Carga inicial de datos
  </script>
</body>
</html>
