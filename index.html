<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Causas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{
      --bg:#a3c8ff; --card:#fff; --primary:#1f3a93; --accent:#3498db;
      --danger:#e74c3c; --success:#27ae60; --warning:#f39c12; --muted:#7f8c8d;
      --radius:12px; --shadow:0 4px 15px rgba(0,0,0,.08); --tag:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:var(--bg);color:#2c3e50;padding:20px}
    h1{margin:0 0 12px;color:var(--primary);text-align:center}

    .container{display:grid;grid-template-columns:1fr 340px;gap:20px;align-items:start}
    .main{min-width:0}
    .sidebar{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;position:sticky;top:14px}
    .sidebar h2{margin:0 0 10px;font-size:1.05rem;color:var(--accent);border-bottom:2px solid var(--accent);padding-bottom:6px}

    .top-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:12px 0}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="text"], select.simple{padding:8px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;font-size:.9rem}

    .btn{border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:.92rem;transition:.2s;white-space:nowrap;line-height:1.2;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{opacity:.95}
    .btn:disabled{background:#ccc;cursor:not-allowed;opacity:.8}
    .btn-nuevo{background:var(--accent);color:#fff}
    .btn-print{background:var(--success);color:#fff}
    .btn-edit{background:var(--warning);color:#fff}
    .btn-delete{background:var(--danger);color:#fff}
    .btn-view{background:var(--primary);color:#fff}
    .btn-ghost{background:#eef2f7;color:#2c3e50}

    .table-wrap{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:.9rem;vertical-align:top;word-break:break-word}
    th{background:var(--primary);color:#fff;position:sticky;top:0;z-index:1}
    tr:hover td{background:#f9fbff}
    .nowrap{white-space:nowrap}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--tag);font-size:.75rem;margin-left:6px}
    .group{margin-bottom:12px}
    .event{display:flex;gap:8px;align-items:flex-start;background:#f0f4f9;border-left:4px solid var(--accent);padding:6px 8px;border-radius:6px;margin:6px 0}
    .event .when{font-weight:600}
    .k{color:#6b7280}

    #modal,#modalVer,#confirmModal,#alertModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;padding:20px;z-index:10}
    #modal .content,#modalVer .content,#confirmModal .content,#alertModal .content{background:#fff;border-radius:16px;max-width:980px;width:100%;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 8px 25px rgba(0,0,0,0.2);animation:fadeIn .25s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

    .modal-header{position:sticky;top:0;background:var(--primary);color:#fff;padding:12px 16px;font-size:1.1rem;font-weight:600;border-radius:16px 16px 0 0;z-index:5;display:flex;align-items:center;gap:10px;justify-content:center}
    .modal-body{padding:16px 16px 0;overflow-y:auto}
    .controls-form{position:sticky;bottom:0;background:#fff;padding:12px 16px;border-top:1px solid #eee;display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;z-index:5}

    #formCausa .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){ #formCausa .grid{grid-template-columns:1fr} .container{grid-template-columns:1fr} .sidebar{position:relative;top:auto} }
    #formCausa label{font-weight:600;color:var(--primary);font-size:0.9rem;margin-bottom:4px;display:block}
    #formCausa input,#formCausa textarea,#formCausa select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font-size:0.9rem;background:#fafafa;transition:.2s}
    #formCausa input:focus,#formCausa textarea:focus,#formCausa select:focus{outline:none;border-color:var(--accent);background:#fff}
    .counter{font-size:.8rem;color:#6b7280;margin-top:4px}
    
    #agregarNota{margin-top:20px;padding:15px;background:#f0f4f9;border:1px solid #ddd;border-radius:10px;}
    #agregarNota label{font-weight:600;color:var(--primary);display:block;margin-bottom:8px;}
    #agregarNota textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;resize:vertical;}
    #agregarNota button{background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;margin-top:10px;}

    #verContenido p{margin:.35rem 0;font-size:.92rem}
    #verContenido strong{color:var(--primary)}
    .note{border-left:3px solid #3498db;padding:6px;margin:6px 0;background:#f9fbff;border-radius:6px}

    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .top-actions .actions .btn{display:flex;align-items:center}
    
    .prioridad-pill{
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: bold;
      color: #fff;
      text-transform: uppercase;
    }
    .prioridad-baja{background-color: var(--success);}
    .prioridad-media{background-color: var(--warning);}
    .prioridad-alta{background-color: var(--danger);}
    .prioridad-ninguna{background-color: var(--muted);}

    #confirmModal .content, #alertModal .content {
      max-width: 400px;
      padding: 24px;
      text-align: center;
      gap: 16px;
    }
    #confirmModal h3, #alertModal h3 {
      margin: 0;
      color: var(--primary);
      font-size: 1.5rem;
    }
    #confirmModal p, #alertModal p {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }
    #confirmModal .actions-row, #alertModal .actions-row {
      display: flex;
      justify-content: space-around;
      gap: 12px;
      margin-top: 20px;
    }
    #confirmModal .actions-row .btn, #alertModal .actions-row .btn {
      flex-grow: 1;
    }
    .alert-danger{ background: var(--danger); color: white; }
    .alert-success{ background: var(--success); color: white; }
    
    .floating-alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--danger);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }

    .floating-alert.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .audiencias-container {
      margin-bottom: 10px;
    }
    .audiencia-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .audiencia-item input {
      flex: 1;
    }
    .btn-eliminar-audiencia {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .btn-audiencia {
      background: var(--success);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      margin-top: 8px;
    }

    /* Estilos para Paginación */
    #paginacion-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-top: 15px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    #paginacion-container .page-info {
      font-size: 0.9rem;
      color: var(--muted);
      font-weight: 500;
    }
    #paginacion-container .nav-buttons {
      display: flex;
      gap: 8px;
    }
    
    /* Estilos para el formulario con pestañas */
    .tabs-container {
      margin-bottom: 15px;
    }
    .tabs-nav {
      display: flex;
      border-bottom: 2px solid #ddd;
    }
    .tab-button {
      background: #f0f0f0;
      border: none;
      padding: 12px 18px;
      cursor: pointer;
      font-weight: 600;
      color: #777;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }
    .tab-button.active {
      background: var(--primary);
      color: #fff;
      position: relative;
      bottom: -2px;
      border-bottom: 2px solid var(--primary);
    }
    .tab-content {
      padding: 15px 0;
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .tab-content .field:not(:last-child) {
        margin-bottom: 10px;
    }

    /* NUEVOS ESTILOS PARA LA VALIDACIÓN */
    .field.error input,
    .field.error textarea,
    .field.error select {
        border-color: var(--danger);
        background-color: #ffeef0;
    }
    .field .error-message {
        color: var(--danger);
        font-size: 0.8rem;
        margin-top: 4px;
        display: none;
    }
    .field.error .error-message {
        display: block;
    }
    .field {
      margin-bottom: 15px;
    }

    /* Resaltado de prioridad en la vista detallada */
    #verContenido .prioridad-destacada {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 10px;
      padding: 12px;
      border-radius: 12px;
      color: #fff;
    }
    .prioridad-destacada h4 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
    }
    .prioridad-destacada .fa-exclamation-triangle {
        font-size: 1.5rem;
    }
    .prioridad-destacada.prioridad-baja{background-color: var(--success);}
    .prioridad-destacada.prioridad-media{background-color: var(--warning);}
    .prioridad-destacada.prioridad-alta{background-color: var(--danger);}
    .prioridad-destacada.prioridad-ninguna{background-color: var(--muted);}

    /* Estilos para el historial de notas */
    .notes-history {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #ddd;
    }
    .notes-history h4 {
        margin: 0 0 10px;
        color: var(--primary);
        font-size: 1rem;
        border-bottom: 2px solid var(--primary);
        padding-bottom: 5px;
    }
    .note-item {
        background: #f8f8f8;
        border-left: 4px solid var(--accent);
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
    }
    .note-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: var(--muted);
        margin-bottom: 5px;
    }
    .note-text {
        font-size: 0.9rem;
        line-height: 1.4;
    }

  </style>
</head>
<body>
  <div class="floating-alert" id="floating-alert"></div>
  <div class="container">
    <div class="main">
      <div class="top-actions">
        <div class="filters">
          <input type="text" id="buscador" placeholder="🔍 Buscar..." />
          <select id="filtroEstado" class="simple">
            <option value="">Estado (todos)</option>
            <option>En trámite</option><option>Finalizado</option><option>En Alzada</option><option>Archivado</option>
          </select>
          <select id="filtroUsuario" class="simple">
            <option value="">Usuario (todos)</option>
          </select>
          <select id="filtroPrioridad" class="simple">
            <option value="">Prioridad (todas)</option>
            <option value="Ninguna">Ninguna</option>
            <option value="Baja">Baja</option>
            <option value="Media">Media</option>
            <option value="Alta">Alta</option>
          </select>
        </div>
        <div class="actions">
          <button id="btnNuevo" class="btn btn-nuevo"><i class="fa fa-plus"></i>Nuevo Expediente</button>
          <button id="btnPrintListado" class="btn btn-print"><i class="fa fa-print"></i>Imprimir Listado</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="nowrap">N°</th><th>Carátula</th><th>Tipo</th><th>Juzgado</th><th>Usuario</th><th>Estado</th><th>Prioridad</th><th class="nowrap">Registro</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyCausas"><tr><td colspan="9">Cargando...</td></tr></tbody>
        </table>
      </div>
      
      <div id="paginacion-container"></div>

    </div>

    <aside class="sidebar">
      <h2>📅 Próximas Fechas (30 días)</h2>
      <div class="group"><div class="k">Audiencias <span class="pill" id="countAud">0</span></div><div id="listAud"></div></div>
      <div class="group"><div class="k">Cámara Gesell <span class="pill" id="countGesell">0</span></div><div id="listGesell"></div></div>
      <div class="group"><div class="k">Vencimientos <span class="pill" id="countVenc">0</span></div><div id="listVenc"></div></div>
      <div class="group"><div class="k">Venc. de Recursos <span class="pill" id="countVrec">0</span></div><div id="listVrec"></div></div>
      <button id="btnPrintFechas" class="btn btn-print" style="margin-top:8px;width:100%"><i class="fa fa-print"></i>Imprimir Fechas</button>
    </aside>
  </div>

  <div id="modal">
    <div class="content">
      <div class="modal-header">
        <i class="fa-solid fa-file-pen"></i>
        <h2 id="tituloForm" style="margin:0;">Nuevo Expediente</h2>
      </div>
      <div class="modal-body">
        <form id="formCausa" action="#" method="post" aria-label="Formulario para nuevo expediente o edición">
          <input type="hidden" id="editId" />
          <div class="tabs-container">
            <div class="tabs-nav">
              <button type="button" class="tab-button active" data-tab="tab1">Datos Principales</button>
              <button type="button" class="tab-button" data-tab="tab2">Fechas y Vencimientos</button>
              <button type="button" class="tab-button" data-tab="tab3">Recursos</button>
              <button type="button" class="tab-button" data-tab="tab4">Observaciones</button>
            </div>

            <div id="tab1" class="tab-content active">
              <div class="field">
                <label for="numCausa">N° Expediente *</label>
                <input id="numCausa" required autocomplete="off" />
                <span class="error-message">Este campo es obligatorio.</span>
              </div>
              <div class="field">
                <label for="caratula">Carátula Completa *</label>
                <textarea id="caratula" rows="2" required></textarea>
                <span class="error-message">Este campo es obligatorio.</span>
              </div>
              <div class="field">
                <label for="tipoProceso">Tipo de Proceso *</label>
                <select id="tipoProceso" required></select>
                <span class="error-message">Este campo es obligatorio.</span>
              </div>
              <div class="field">
                <label for="juzgado">Juzgado *</label>
                <select id="juzgado" required></select>
                <span class="error-message">Este campo es obligatorio.</span>
              </div>
              <div class="field">
                <label for="prioridad">Prioridad *</label>
                <select id="prioridad" class="simple" required>
                  <option value="Ninguna"><strong>Ninguna</strong> (gris)</option>
                  <option value="Baja"><strong>Baja</strong> (verde)</option>
                  <option value="Media"><strong>Media</strong> (naranja)</option>
                  <option value="Alta"><strong>Alta</strong> (roja)</option>
                </select>
                <span class="error-message">Este campo es obligatorio.</span>
              </div>
              <div class="field">
                <label for="usuarioAsignado">Usuario Asignado *</label>
                <select id="usuarioAsignado" required></select>
                <span class="error-message">Este campo es obligatorio.</span>
              </div>
              <div class="field">
                <label for="estado">Estado del Proceso</label>
                <select id="estado"><option>En trámite</option><option>Finalizado</option><option>Archivado</option><option>En Alzada</option></select>
              </div>
              <div class="field">
                <label for="intervencion">Intervención</label>
                <select id="intervencion">
                  <option>Ministerio Principal</option><option>Ministerio Complementario</option><option>Patrocinante Actor</option>
                  <option>Patrocinante Demandado</option><option>Patrocinante Tercero</option><option value="Defensor de Ausente">Defensor de Ausente</option><option>Patrocinante presunto incapaz</option></option>
                  <option value="Defensor Oficial Asesor Letrado">Asesor Letrado</option><option>Ministerio Público del incapaz</option><option>Ministerio Público en turno Abril</option><option>Ministerio Público en turno Agosto</option><option>Ministerio Público en turno Diciembre</option>    
                </select>
              </div>
              <div class="field">
                <label for="datosNnya">Datos de NNyA (máx. 500 palabras)</label>
                <textarea id="datosNnya" disabled></textarea><div class="counter" id="counterNnya" style="display:none">0/500</div>
              </div>
            </div>

            <div id="tab2" class="tab-content">
              <div class="field"><label for="fechaInicio">Fecha de Inicio</label><input type="date" id="fechaInicio" /></div>
              <div class="field"><label for="fechaPase">Fecha de Pase</label><input type="datetime-local" id="fechaPase" /></div>
              <div class="field"><label for="vencimiento">Vencimiento</label><input type="datetime-local" id="vencimiento" /></div>
              <div class="field">
                <label for="audiencias">Audiencias señaladas</label>
                <div id="audiencias-container" class="audiencias-container"></div>
                <button type="button" id="btnAgregarAudiencia" class="btn-audiencia"><i class="fa fa-plus"></i> Agregar Audiencia</button>
              </div>
              <div class="field">
                <label for="audienciaGesell">Audiencia en Cámara Gesell</label>
                <div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="habilitarAudienciaGesell" /><span>Habilitar</span></div>
                <input type="datetime-local" id="audienciaGesell" disabled />
              </div>
              <div class="field">
                <label for="nnyaGesell">NNyA en Gesell (máx. 400 palabras)</label>
                <textarea id="nnyaGesell" disabled></textarea><div class="counter" id="counterNnyaGesell" style="display:none">0/400</div>
              </div>
            </div>

            <div id="tab3" class="tab-content">
              <div class="field">
                <label for="recursos">Recursos Interpuestos</label>
                <select id="recursos"><option value="">Seleccione un recurso</option><option>Apelación</option><option>Queja</option><option>Inconstitucionalidad</option><option>Nulidad</option><option>Reposición</option><option>Aclaratoria</option><option>Recurso Extraordinario</option><option>Recurso de Inaplicabilidad</option></select>
              </div>
              <div id="recursos-opcionales" style="display:none;">
                <div class="field">
                  <label for="recursosContestacion">Recursos Contestación</label>
                  <select id="recursosContestacion"><option value="">Seleccione un recurso</option><option>Apelación</option><option>Queja</option><option>Inconstitucionalidad</option><option>Nulidad</option><option>Reposición</option><option>Aclaratoria</option><option>Recurso Extraordinario</option><option>Recurso de Inaplicabilidad</option></select>
                </div>
                <div class="field">
                  <label for="estadoRecursos">Estado de Recursos</label>
                  <select id="estadoRecursos"><option value="">Seleccione un estado</option><option>Pendiente</option><option>En trámite</option><option>Resuelto</option><option>Rechazado</option></select>
                </div>
                <div class="field">
                  <label for="vencimientoRecursos">Vencimiento de Recursos</label>
                  <input type="datetime-local" id="vencimientoRecursos" />
                </div>
              </div>
            </div>

            <div id="tab4" class="tab-content">
              <div class="field">
                <label for="observaciones">Observaciones (máx. 1000 palabras)</label>
                <textarea id="observaciones" rows="5"></textarea><div class="counter" id="counter">0/1000</div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="controls-form">
        <button class="btn-add" type="button" id="btnGuardar"><i class="fa fa-save"></i>Guardar</button>
        <button class="btn-print" type="button" id="btnPrintForm"><i class="fa fa-print"></i>Imprimir</button>
      </div>
    </div>
  </div>

  <div id="modalVer">
    <div class="content">
      <div class="modal-header">
        <i class="fa-solid fa-eye"></i>
        <h2 style="margin:0;">Detalle del Expediente</h2>
      </div>
      <div class="modal-body">
        <div id="verContenido"></div>
        <div id="agregarNota">
          <label for="notaBitacora">Agregar Nota de Seguimiento:</label>
          <textarea id="notaBitacora" placeholder="Escribe aquí la nota..."></textarea>
          <button id="btnAgregarNota"><i class="fa fa-plus"></i> Guardar Nota</button>
        </div>
        <div class="notes-history">
            <h4>Historial de Notas</h4>
            <div id="historialNotas"></div>
        </div>
      </div>
      <div class="controls-form" style="justify-content:flex-end;">
        <a href="https://defensoria6.github.io/linea-tiempo/" id="btnVerLineaTiempo" class="btn btn-view"><i class="fa-solid fa-timeline"></i> Ver Línea de Tiempo</a>
        <button id="btnCerrarVer" class="btn btn-ghost"><i class="fa fa-xmark"></i>Cerrar</button>
        <button id="btnPrintRegistro" class="btn btn-print"><i class="fa fa-print"></i>Imprimir Registro</button>
      </div>
    </div>
  </div>

  <div id="confirmModal">
    <div class="content">
      <h3>¿Estás seguro?</h3>
      <p>Esta acción eliminará el registro de forma permanente. No se puede deshacer.</p>
      <div class="actions-row">
        <button id="btnConfirmarEliminar" class="btn btn-delete"><i class="fa fa-trash"></i> Eliminar</button>
        <button id="btnCancelarEliminar" class="btn btn-ghost"><i class="fa fa-xmark"></i> Cancelar</button>
      </div>
    </div>
  </div>

  <div id="alertModal">
    <div class="content">
      <h3 id="alertTitle"></h3>
      <p id="alertMessage"></p>
      <div class="actions-row">
        <button id="btnAlertOK" class="btn alert-success"><i class="fa fa-check"></i> OK</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
  // ===== Firebase (COMPAT) =====
  const firebaseConfig = {
    apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
    authDomain: "causas-defensoria.firebaseapp.com",
    projectId: "causas-defensoria",
    storageBucket: "causas-defensoria.appspot.com",
    messagingSenderId: "186064671470",
    appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
  };
  
  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ===== Helpers UI =====
  const $ = (id)=>document.getElementById(id);
  const tbody = $("tbodyCausas");
  const modal = $("modal");
  const modalVer = $("modalVer");
  const verContenido = $("verContenido");
  const tituloForm = $("tituloForm");
  const editId = $("editId");
  const buscador = $("buscador");
  const filtroEstado = $("filtroEstado");
  const filtroUsuario = $("filtroUsuario");
  const filtroPrioridad = $("filtroPrioridad");
  
  const notaBitacora = $("notaBitacora");
  const historialNotas = $("historialNotas");
  const btnAgregarNota = $("btnAgregarNota");
  const btnVerLineaTiempo = $("btnVerLineaTiempo");

  const listAud = $("listAud");
  const listGes = $("listGesell");
  const listVenc = $("listVenc");
  const listVrec = $("listVrec");
  const cAud = $("countAud");
  const cGes = $("countGesell");
  const cVenc = $("countVenc");
  const cVrec = $("countVrec");

  const floatingAlert = $("floating-alert");
  const audienciasContainer = $("audiencias-container");
  const btnAgregarAudiencia = $("btnAgregarAudiencia");
  
  const confirmModal = $("confirmModal");
  const btnConfirmarEliminar = $("btnConfirmarEliminar");
  const btnCancelarEliminar = $("btnCancelarEliminar");
  
  const alertModal = $("alertModal");
  const alertTitle = $("alertTitle");
  const alertMessage = $("alertMessage");
  const btnAlertOK = $("btnAlertOK");

  // ===== PAGINACIÓN del lado del Servidor y Realtime =====
  const recordsPerPage = 10;
  let firstVisible = null;
  let lastVisible = null;
  let queryDirection = 'next';
  let history = []; // Historial para la navegación 'atrás'
  
  // ===== Variables de estado para los filtros =====
  let datosCache = [];
  let paginaActual = 1;
  let datosFiltrados = [];
  
  // ===== Utils =====
  const toDate = (v)=> v?.toDate ? v.toDate() : (v?.seconds ? new Date(v.seconds*1000) : (v ? new Date(v) : null));
  
  function formatearFecha(d, conHora = false) {
    const fecha = toDate(d);
    if (!fecha || isNaN(fecha)) return "";

    const dia = String(fecha.getDate()).padStart(2, '0');
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const año = fecha.getFullYear();
    
    if (!conHora) {
      return `${dia}/${mes}/${año}`;
    }
    
    const horas = String(fecha.getHours()).padStart(2, '0');
    const minutos = String(fecha.getMinutes()).padStart(2, '0');
    
    return `${dia}/${mes}/${año} ${horas}:${minutos}`;
  }
  
  const prioridadClase = (p)=>{
    p = (p || "Ninguna").toLowerCase();
    if(p === "alta") return "prioridad-alta";
    if(p === "media") return "prioridad-media";
    if(p === "baja") return "prioridad-baja";
    return "prioridad-ninguna";
  };

  let causaActualId = null;
  let unsubCausas = null;

  // Variables para datos dinámicos de Firestore
  let usuariosCache = [];
  let juzgadosPorTipoCache = {};

  // ===== Funciones para cargar datos de Firestore =====
  async function cargarUsuarios() {
      try {
          const snapshot = await db.collection("usuarios").get();
          usuariosCache = [];
          snapshot.forEach(doc => {
              const data = doc.data();
              if (data.nombreCompleto) {
                  usuariosCache.push(data.nombreCompleto);
              }
          });
          usuariosCache.sort((a, b) => a.localeCompare(b));
      } catch (e) {
          console.error("Error al cargar usuarios:", e);
      }
  }

  async function cargarJuzgados() {
      try {
          const snapshot = await db.collection("juzgados").get();
          juzgadosPorTipoCache = {};
          snapshot.forEach(doc => {
              const { tipo, nombre } = doc.data();
              if (tipo && nombre) {
                  if (!juzgadosPorTipoCache[tipo]) {
                      juzgadosPorTipoCache[tipo] = [];
                  }
                  juzgadosPorTipoCache[tipo].push(nombre);
              }
          });
          Object.keys(juzgadosPorTipoCache).forEach(tipo => {
              juzgadosPorTipoCache[tipo].sort((a, b) => a.localeCompare(b));
          });
      } catch (e) {
          console.error("Error al cargar juzgados:", e);
      }
  }

  // ===== Funciones para poblar selects =====
  function poblarTiposProceso() {
      const selTipo = $("tipoProceso");
      const tipos = Object.keys(juzgadosPorTipoCache).sort((a, b) => a.localeCompare(b));
      selTipo.innerHTML = '<option value="">Seleccione un tipo</option>' + 
          tipos.map(t => `<option value="${t}">${t}</option>`).join('');
  }

  function poblarJuzgadosPorTipo(tipoSeleccionado) {
      const selJuz = $("juzgado");
      const juzgados = juzgadosPorTipoCache[tipoSeleccionado] || [];
      selJuz.innerHTML = '<option value="">Seleccione un juzgado</option>' + 
          juzgados.map(j => `<option value="${j}">${j}</option>`).join('');
  }

  function poblarSelectUsuarios() {
      const selUsu = $("usuarioAsignado");
      selUsu.innerHTML = '<option value="">Seleccione un usuario</option>' + 
          usuariosCache.map(u => `<option value="${u}">${u}</option>`).join('');
  }

  function poblarFiltroUsuarios() {
      const current = filtroUsuario.value; 
      filtroUsuario.innerHTML = '<option value="">Usuario (todos)</option>' + 
          usuariosCache.map(u => `<option value="${u}">${u}</option>`).join('');
      if (current) filtroUsuario.value = current;
  }

  // ===== Lógica de paginación y carga de datos desde el servidor =====
  function suscribirCausas() {
    if (unsubCausas) unsubCausas();
    unsubCausas = db.collection("causas").orderBy("fechaRegistro", "desc").onSnapshot(
      snap => {
        datosCache = [];
        snap.forEach(d => datosCache.push({ id: d.id, ...d.data() }));
        handleFilterChange();
        renderSidebar(datosCache);
        poblarFiltroUsuarios();
      },
      err => {
        console.error("onSnapshot causas:", err);
        tbody.innerHTML = "<tr><td colspan='9'>Error al cargar los datos.</td></tr>";
      }
    );
  }

  // ===== Filtros y Paginación (del lado del cliente) =====
  function filtrarDatos() {
    const q = (buscador.value || "").toLowerCase();
    const est = (filtroEstado.value || "").toLowerCase();
    const usu = (filtroUsuario.value || "").toLowerCase();
    const prio = (filtroPrioridad.value || "").toLowerCase();
    
    return datosCache.filter(d => {
      const okTexto = !q || (d.numCausa?.toLowerCase().includes(q) || d.caratula?.toLowerCase().includes(q));
      const okEstado = !est || (d.estado || "").toLowerCase() === est;
      const okUsuario = !usu || (d.usuarioAsignado || "").toLowerCase() === usu;
      const okPrioridad = !prio || (d.prioridad || "").toLowerCase() === prio;
      return okTexto && okEstado && okUsuario && okPrioridad;
    });
  }

  const handleFilterChange = () => {
    datosFiltrados = filtrarDatos();
    paginaActual = 1;
    renderTablaPaginada();
  };
  
  const renderTablaPaginada = () => {
    const startIndex = (paginaActual - 1) * recordsPerPage;
    const endIndex = startIndex + recordsPerPage;
    const dataToRender = datosFiltrados.slice(startIndex, endIndex);
    renderTablas(dataToRender);
    renderPaginacion(datosFiltrados.length, dataToRender.length);
  };
  
  buscador.oninput = handleFilterChange;
  filtroEstado.onchange = handleFilterChange;
  filtroUsuario.onchange = handleFilterChange;
  filtroPrioridad.onchange = handleFilterChange;
  
  // ===== Render =====
  function accionesHTML(id){
    return `<button class="btn-view" data-id="${id}" title="Ver"><i class="fa fa-eye"></i></button>
            <button class="btn-edit" data-id="${id}" title="Editar"><i class="fa fa-pen"></i></button>
            <a href="https://defensoria6.github.io/linea-tiempo/?id=${id}" class="btn-view" title="Ver Línea de Tiempo"><i class="fa-solid fa-timeline"></i></a>`;
  }

  function renderTablas(data){
    tbody.innerHTML = data.length ? "" : "<tr><td colspan='9'>No hay registros</td></tr>";
    data.forEach(d=>{
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td class="mono">${d.numCausa||""}</td>
          <td>${d.caratula||""}</td>
          <td>${d.tipoProceso||""}</td>
          <td>${d.juzgado||""}</td>
          <td>${d.usuarioAsignado||""}</td>
          <td>${d.estado||""}</td>
          <td><span class="prioridad-pill ${prioridadClase(d.prioridad)}">${d.prioridad||"Ninguna"}</span></td>
          <td class="nowrap">${formatearFecha(d.fechaRegistro, false)}</td>
          <td class="nowrap">${accionesHTML(d.id)}</td>
        </tr>`);
    });

    document.querySelectorAll(".btn-view").forEach(b=>b.onclick=()=>abrirVer(b.dataset.id));
    document.querySelectorAll(".btn-edit").forEach(b=>b.onclick=()=>abrirEditar(b.dataset.id));
  }

  // ===== PAGINACIÓN: Render y Controles =====
  function renderPaginacion(totalRecords, recordsOnPage) {
    const container = $("paginacion-container");
    const totalPages = Math.ceil(totalRecords / recordsPerPage);
    container.style.display = totalPages > 1 ? "flex" : "none";
    container.innerHTML = `
      <div class="page-info">
        Página ${paginaActual} de ${totalPages} | Mostrando ${recordsOnPage} de ${totalRecords} registros
      </div>
      <div class="nav-buttons">
        <button id="btnPrevPage" class="btn btn-ghost" ${paginaActual === 1 ? 'disabled' : ''}><i class="fa fa-arrow-left"></i> Anterior</button>
        <button id="btnNextPage" class="btn btn-ghost" ${paginaActual === totalPages ? 'disabled' : ''}>Siguiente <i class="fa fa-arrow-right"></i></button>
      </div>
    `;

    $("btnPrevPage").onclick = () => {
      paginaActual--;
      renderTablaPaginada();
    };

    $("btnNextPage").onclick = () => {
      paginaActual++;
      renderTablaPaginada();
    };
  }

  // ===== Sidebar (eventos próximos) =====
  function renderSidebar(data){
    const hoy = new Date();
    const limite = new Date(hoy.getTime() + 30*24*60*60*1000);
    const eventos = {aud:[], ges:[], venc:[], vrec:[]};
    
    const pushIfRange = (arr, fecha, label)=>{ 
      const f = toDate(fecha); 
      if(!f || isNaN(f)) return; 
      if(f >= hoy && f <= limite) arr.push({f, label}); 
    };
    
    data.forEach(d=>{
      const id = d.numCausa || d.id;
      
      // Audiencias
      if (Array.isArray(d.audiencias)) {
        d.audiencias.forEach(aud => {
          pushIfRange(eventos.aud, aud, `${id} - Audiencia`);
        });
      } else if (d.audiencias) {
        pushIfRange(eventos.aud, d.audiencias, `${id} - Audiencia`);
      }
      
      // Cámara Gesell
      pushIfRange(eventos.ges, d.audienciaGesell, `${id} - Cámara Gesell`);
      
      // Vencimientos
      pushIfRange(eventos.venc, d.vencimiento, `${id} - Vencimiento`);
      
      // Vencimientos de Recursos
      pushIfRange(eventos.vrec, d.vencimientoRecursos, `${id} - ${d.recursos||'Recurso'}`);
    });
    
    const renderList = (arr, target, counterRef, empty)=>{
      arr.sort((a,b)=>a.f - b.f); 
      target.innerHTML="";
      
      if(!arr.length){ 
        target.innerHTML = `<div class="k">${empty}</div>`; 
        counterRef.textContent = "0"; 
        return; 
      }
      
      counterRef.textContent = String(arr.length);
      arr.forEach(e=> {
        target.insertAdjacentHTML("beforeend", 
          `<div class="event">
            <div class="when">${formatearFecha(e.f, true)}</div>
            <div class="what">— ${e.label}</div>
          </div>`
        );
      });
    };
    
    renderList(eventos.aud, listAud, cAud, "No hay audiencias próximas");
    renderList(eventos.ges, listGes, cGes, "No hay Cámaras Gesell próximas");
    renderList(eventos.venc, listVenc, cVenc, "No hay vencimientos próximos");
    renderList(eventos.vrec, listVrec, cVrec, "No hay venc. de recursos próximos");
  }

  // ===== ABM Causas =====
  $("btnNuevo").onclick = async ()=>{ 
    modo = "nuevo"; 
    resetFormCausa(); 
    editId.value = ""; 
    tituloForm.textContent = "Nuevo Expediente"; 
    await initForm();
    modal.style.display = "flex"; 
  };
  
  // Función de validación mejorada
  function validateForm() {
    let isValid = true;
    const requiredFields = ["numCausa", "caratula", "tipoProceso", "juzgado", "prioridad", "usuarioAsignado"];
    
    requiredFields.forEach(id => {
        const field = $(id);
        const parent = field.closest('.field');
        if (field.value.trim() === "") {
            parent.classList.add('error');
            isValid = false;
        } else {
            parent.classList.remove('error');
        }
    });

    if (modo === "nuevo") {
        const numCausa = $("numCausa").value.trim();
        const numCausaExistente = datosCache.some(d => d.numCausa === numCausa);
        const numCausaField = $("numCausa").closest('.field');
        
        if (numCausaExistente) {
            numCausaField.classList.add('error');
            numCausaField.querySelector('.error-message').textContent = "Esta causa ya se encuentra registrada.";
            isValid = false;
        } else {
            numCausaField.classList.remove('error');
            numCausaField.querySelector('.error-message').textContent = "Este campo es obligatorio.";
        }
    }

    return isValid;
  }
  
  const mostrarAlertaPersonalizada = (titulo, mensaje) => {
    alertTitle.textContent = titulo;
    alertMessage.textContent = mensaje;
    alertModal.style.display = "flex";
  };
  
  btnAlertOK.onclick = () => {
    alertModal.style.display = "none";
  };
  
  const mostrarConfirmacion = (titulo, mensaje, onConfirm) => {
    $("confirmModalTitle").textContent = titulo;
    $("confirmModalMessage").textContent = mensaje;
    confirmModal.style.display = "flex";
    btnConfirmarEliminar.onclick = onConfirm;
    btnCancelarEliminar.onclick = () => {
      confirmModal.style.display = "none";
      btnConfirmarEliminar.onclick = null;
    };
  };

  const confirmacionGuardar = () => {
    if (!validateForm()) {
        mostrarAlertaPersonalizada("Error de Validación", "Por favor, completa los campos obligatorios.");
        return; 
    }
    const mensaje = (modo === "nuevo") ? "¿Estás seguro de que quieres guardar este expediente?" : "¿Estás seguro de que quieres actualizar este expediente?";
    
    const onConfirm = async () => {
        const datos = recolectarDatosForm();
        const btnGuardar = $("btnGuardar");
        btnGuardar.disabled = true;
        try{
            if (modo==="nuevo"){
              await db.collection("causas").add({...datos, fechaRegistro: firebase.firestore.FieldValue.serverTimestamp()});
              mostrarAlertaPersonalizada("¡Éxito!", "Expediente guardado correctamente.");
            }else{
              await db.collection("causas").doc(editId.value).update(datos);
              mostrarAlertaPersonalizada("¡Éxito!", "Expediente actualizado correctamente.");
            }
            modal.style.display = "none";
        }catch(e){ 
            console.error(e); 
            mostrarAlertaPersonalizada("Error", "No se pudo guardar. Revisa la consola."); 
        } finally {
            btnGuardar.disabled = false;
            confirmModal.style.display = "none";
        }
    };
    mostrarConfirmacion("Confirmar Acción", mensaje, onConfirm);
  };
  
  $("btnGuardar").onclick = confirmacionGuardar;
  
  // No hay botón cancelar, se elimina el handler
  // const confirmacionCancelar = () => {
  //   const onConfirm = () => {
  //     modal.style.display = "none";
  //     confirmModal.style.display = "none";
  //   };
  //   mostrarConfirmacion("Confirmar Cancelación", "¿Estás seguro de que quieres cancelar? Los cambios no guardados se perderán.", onConfirm);
  // };
  // $("btnCancelar").onclick = confirmacionCancelar;

  function abrirConfirmarEliminar(id) {
    const onConfirm = async () => {
      try {
        await db.collection("causas").doc(id).delete();
        confirmModal.style.display = "none";
        mostrarAlertaPersonalizada("Eliminado", "Expediente eliminado correctamente.");
      } catch (e) {
        console.error("Error al eliminar el expediente:", e);
        mostrarAlertaPersonalizada("Error", "No se pudo eliminar el registro.");
      }
    };
    mostrarConfirmacion("¿Estás seguro?", "Esta acción eliminará el registro de forma permanente. No se puede deshacer.", onConfirm);
  }
  
  async function abrirEditar(id){
    modo = "editar"; resetFormCausa(); editId.value = id; tituloForm.textContent = "Editar Expediente";
    try{
      const snap = await db.collection("causas").doc(id).get();
      if (snap.exists){
        await initForm();
        cargarDatosEnForm(snap.data());
        modal.style.display = "flex"; 
      } else {
        mostrarAlertaPersonalizada("Error", "El expediente no fue encontrado.");
      }
    }catch(e){ 
      console.error(e); 
      mostrarAlertaPersonalizada("Error", "No se pudo abrir el registro."); 
    }
  }
  
  async function abrirVer(id){
    causaActualId = id;
    try{
        const snap = await db.collection("causas").doc(id).get();
        if (!snap.exists) {
            mostrarAlertaPersonalizada("Error", "El expediente no fue encontrado.");
            return;
        }
        const d = snap.data();
        let contenidoHTML = "";

        const prioridadDestacada = `<div class="prioridad-destacada ${prioridadClase(d.prioridad)}"><i class="fa fa-exclamation-triangle"></i><h4>PRIORIDAD ${d.prioridad.toUpperCase()}</h4></div>`;
        contenidoHTML += prioridadDestacada;
        
        const etiquetas = {
            numCausa: "N° Expediente", caratula: "Carátula", tipoProceso: "Tipo de Proceso", juzgado: "Juzgado",
            fechaInicio: "Fecha de Inicio", fechaPase: "Fecha de Pase", intervencion: "Intervención",
            datosNnya: "Datos de NNyA", vencimiento: "Vencimiento", usuarioAsignado: "Usuario Asignado",
            estado: "Estado", prioridad: "Prioridad", recursos: "Recursos Interpuestos",
            recursosContestacion: "Contestación de Recursos", estadoRecursos: "Estado de Recursos",
            vencimientoRecursos: "Vencimiento de Recursos", audienciaGesell: "Audiencia Gesell",
            nnyaGesell: "NNyA en Gesell", observaciones: "Observaciones", fechaRegistro: "Fecha de Registro"
        };
        
        const ordenClaves = [
            "numCausa", "caratula", "tipoProceso", "juzgado", "estado", "usuarioAsignado",
            "fechaRegistro", "fechaInicio", "fechaPase", "intervencion", "datosNnya", "vencimiento",
            "audiencias", "recursos", "recursosContestacion", "estadoRecursos", "vencimientoRecursos",
            "audienciaGesell", "nnyaGesell", "observaciones"
        ];
        
        ordenClaves.forEach(k => {
            const v = d[k];
            if (v !== null && v !== undefined && v !== "" && k !== "prioridad") {
                const etiqueta = etiquetas[k] || k;
                if (k === "audiencias" && Array.isArray(v) && v.length > 0) {
                    contenidoHTML += `<p><strong>Audiencias:</strong></p>`;
                    v.forEach(aud => {
                        contenidoHTML += `<p style="margin-left: 20px;">${formatearFecha(aud, true)}</p>`;
                    });
                } else if (['fechaInicio', 'fechaRegistro'].includes(k)) {
                    contenidoHTML += `<p><strong>${etiqueta}:</strong> ${formatearFecha(v, false)}</p>`;
                } else if (v.seconds) {
                    contenidoHTML += `<p><strong>${etiqueta}:</strong> ${formatearFecha(v, true)}</p>`;
                } else if (k !== "audiencias") {
                    contenidoHTML += `<p><strong>${etiqueta}:</strong> ${v}</p>`;
                }
            }
        });

        verContenido.innerHTML = contenidoHTML;
        await cargarNotas(id);
        btnVerLineaTiempo.href = `https://defensoria6.github.io/linea-tiempo/?id=${causaActualId}`;
        modalVer.style.display = "flex";
    } catch(e) {
        console.error(e);
        mostrarAlertaPersonalizada("Error", "No se pudo abrir el detalle.");
    }
  }
  
  async function cargarNotas(causaId) {
      historialNotas.innerHTML = "Cargando notas...";
      try {
          const snapshot = await db.collection("causas").doc(causaId).collection("seguimiento").orderBy("fecha", "desc").get();
          if (snapshot.empty) {
              historialNotas.innerHTML = `<p class="k">No hay notas de seguimiento.</p>`;
              return;
          }
          historialNotas.innerHTML = "";
          snapshot.forEach(doc => {
              const nota = doc.data();
              const fecha = formatearFecha(nota.fecha, true);
              const notaHTML = `
                <div class="note-item">
                  <div class="note-meta">
                    <span>${fecha}</span>
                    <span>por: ${nota.usuario || "Anónimo"}</span>
                  </div>
                  <div class="note-text">${nota.texto}</div>
                </div>
              `;
              historialNotas.insertAdjacentHTML("beforeend", notaHTML);
          });
      } catch(e) {
          console.error("Error al cargar notas:", e);
          historialNotas.innerHTML = `<p class="k">Error al cargar notas.</p>`;
      }
  }

  async function agregarNota() {
    if (!causaActualId) return mostrarAlertaPersonalizada("Error", "No se ha seleccionado una causa.");
    const notaTexto = notaBitacora.value.trim();
    if (!notaTexto) return mostrarAlertaPersonalizada("Error", "Por favor, escribe un texto para la nota.");
    const usuario = "Usuario Actual"; 
    try {
      await db.collection("causas").doc(causaActualId).collection("seguimiento").add({
        texto: notaTexto, fecha: firebase.firestore.FieldValue.serverTimestamp(), usuario: usuario
      });
      notaBitacora.value = "";
      cargarNotas(causaActualId);
      mostrarAlertaPersonalizada("¡Éxito!", "Nota guardada con éxito.");
    } catch (e) {
      console.error("Error al guardar la nota:", e);
      mostrarAlertaPersonalizada("Error", "No se pudo guardar la nota.");
    }
  }
  
  btnAgregarNota.onclick = agregarNota;
  $("btnCerrarVer").onclick = ()=> modalVer.style.display = "none";
  
  const printSection = (html)=>{ const w = window.open("","_blank","width=900,height=700"); w.document.write(`<html><head><title>Imprimir</title></head><body>${html}</body></html>`); w.document.close(); w.focus(); w.print(); };
  $("btnPrintListado").onclick = ()=>{ const head = tbody.closest("table").querySelector("thead").outerHTML; const body = tbody.outerHTML; printSection(`<table style="width:100%;border-collapse:collapse">${head}${body}</table>`); };
  $("btnPrintFechas").onclick = ()=>{ const html = `<h3>Audiencias</h3>${listAud.outerHTML}<h3>Cámara Gesell</h3>${listGes.outerHTML}<h3>Vencimientos</h3>${listVenc.outerHTML}<h3>Venc. de Recursos</h3>${listVrec.outerHTML}`; printSection(html); };
  $("btnPrintForm").onclick = ()=> printSection($("formCausa").outerHTML);
  $("btnPrintRegistro").onclick = ()=> printSection($("verContenido").outerHTML);

  // ===== Formulario - Lógica de Pestañas y Campos Condicionales =====
  const selTipo = $("tipoProceso"), selJuz = $("juzgado"), selUsu = $("usuarioAsignado"), selPrioridad = $("prioridad");
  const tabButtons = document.querySelectorAll(".tab-button");
  const tabContents = document.querySelectorAll(".tab-content");
  
  tabButtons.forEach(button => {
    button.addEventListener("click", () => {
      tabButtons.forEach(btn => btn.classList.remove("active"));
      tabContents.forEach(content => content.classList.remove("active"));
      
      button.classList.add("active");
      const tabId = button.dataset.tab;
      $(tabId).classList.add("active");
    });
  });

  function toggleFormFields(enable) {
      const formFields = document.querySelectorAll('#formCausa input, #formCausa textarea, #formCausa select');
      formFields.forEach(field => {
          if (field.id !== 'numCausa' && field.id !== 'editId') {
              field.disabled = !enable;
          }
      });
      $("btnGuardar").disabled = !enable;
  }
  
  function validarExistenciaCausa() {
      if (modo !== "nuevo") return;
      const numCausa = $("numCausa").value.trim();
      const numCausaField = $("numCausa").closest('.field');
      const numCausaExistente = datosCache.some(d => d.numCausa === numCausa);
      
      if (numCausaExistente) {
          numCausaField.classList.add('error');
          numCausaField.querySelector('.error-message').textContent = "Esta causa ya se encuentra registrada.";
          toggleFormFields(false);
      } else {
          numCausaField.classList.remove('error');
          numCausaField.querySelector('.error-message').textContent = "Este campo es obligatorio.";
          toggleFormFields(true);
      }
  }

  async function initForm(){
    poblarTiposProceso();
    poblarSelectUsuarios();
    
    selTipo.addEventListener("change", function() {
        poblarJuzgadosPorTipo(this.value);
    });
    
    $("recursos").addEventListener("change", function(){
      const recursosOpcionales = $("recursos-opcionales");
      recursosOpcionales.style.display = this.value ? "block" : "none";
    });
    
    toggleGesell(false); 
    $("habilitarAudienciaGesell").checked = false;

    // Agregar el validador en tiempo real al campo de numCausa
    $("numCausa").addEventListener("input", validarExistenciaCausa);
  }
  
  $("intervencion").addEventListener("change", function(){
    const datosNnya = $("datosNnya"), contadorNnya = $("counterNnya");
    if (this.value === "Ministerio Complementario") { 
        datosNnya.removeAttribute("disabled"); 
        contadorNnya.style.display='block'; 
    } else { 
        datosNnya.value = ""; 
        datosNnya.setAttribute("disabled","true"); 
        contadorNnya.style.display='none'; 
    }
  });
  
  const limitWords = (text, max)=>{ 
    const words = text.trim().split(/\s+/).filter(Boolean); 
    return words.length > max ? words.slice(0,max).join(" ") : text; 
  };
  
  $("observaciones").addEventListener("input", function(){ 
    this.value = limitWords(this.value, 1000); 
    $("counter").textContent = `${this.value.trim().split(/\s+/).filter(Boolean).length}/1000`; 
  });
  
  $("datosNnya").addEventListener("input", function(){ 
    this.value = limitWords(this.value, 500); 
    $("counterNnya").textContent = `${this.value.trim().split(/\s+/).filter(Boolean).length}/500`; 
  });
  
  $("nnyaGesell").addEventListener("input", function(){ 
    this.value = limitWords(this.value, 400); 
    $("counterNnyaGesell").textContent = `${this.value.trim().split(/\s+/).filter(Boolean).length}/400`; 
  });
  
  $("habilitarAudienciaGesell").addEventListener("change", function(){ 
    toggleGesell(this.checked); 
  });
  
  function toggleGesell(enabled){ 
    const ag = $("audienciaGesell"), ng = $("nnyaGesell"); 
    if (enabled){ 
        ag.removeAttribute("disabled"); 
        ng.removeAttribute("disabled"); 
        $("counterNnyaGesell").style.display='block'; 
    } else { 
        ag.value = ""; 
        ng.value = ""; 
        ag.setAttribute("disabled","true"); 
        ng.setAttribute("disabled","true"); 
        $("counterNnyaGesell").style.display='none'; 
    } 
  }
  
  function resetFormCausa(){ 
    $("formCausa").reset(); 
    $("counter").textContent = "0/1000"; 
    $("counterNnya").textContent = "0/500"; 
    $("counterNnyaGesell").textContent = "0/400"; 
    selPrioridad.value = "Ninguna"; 
    audienciasContainer.innerHTML = ""; 
    agregarAudiencia();
    
    document.querySelectorAll('.field.error').forEach(el => el.classList.remove('error'));
    
    // Volver a la primera pestaña
    tabButtons.forEach(btn => btn.classList.remove("active"));
    tabContents.forEach(content => content.classList.remove("active"));
    tabButtons[0].classList.add("active");
    tabContents[0].classList.add("active");
    $("recursos-opcionales").style.display = "block";
    toggleFormFields(true);
  }

  function recolectarDatosForm(){
    const fields = ["numCausa","caratula","tipoProceso","juzgado","fechaInicio","fechaPase","intervencion","datosNnya","vencimiento","usuarioAsignado","estado","prioridad","recursos","recursosContestacion","estadoRecursos","vencimientoRecursos","audienciaGesell","nnyaGesell","observaciones"];
    const datos = {};
    
    fields.forEach(id=>{ 
        const el = $(id); 
        if(!el) return; 
        
        if (["date","datetime-local"].includes(el.type)) { 
            datos[id] = el.value ? new Date(el.value) : null;
        } else { 
            datos[id] = el.value || ""; 
        } 
    });
    
    const audiencias = [];
    audienciasContainer.querySelectorAll('input[type="datetime-local"]').forEach(input => { 
        if (input.value) audiencias.push(new Date(input.value)); 
    });
    datos.audiencias = audiencias.length > 0 ? audiencias : null;
    
    return datos;
  }
  
  function cargarDatosEnForm(d) {
      const formatFechaParaInput = (fecha, conHora = true) => {
          if (!fecha || isNaN(fecha)) return "";
          const año = fecha.getFullYear();
          const mes = String(fecha.getMonth() + 1).padStart(2, '0');
          const dia = String(fecha.getDate()).padStart(2, '0');
          if (!conHora) {
              return `${año}-${mes}-${dia}`;
          }
          const horas = String(fecha.getHours()).padStart(2, '0');
          const minutos = String(fecha.getMinutes()).padStart(2, '0');
          return `${año}-${mes}-${dia}T${horas}:${minutos}`;
      };
      
      const setVal = (id, val) => {
          const el = $(id);
          if (!el) return;
          if (val?.seconds) {
              const fecha = toDate(val);
              if (el.type === "date") {
                  el.value = formatFechaParaInput(fecha, false);
              } else if (el.type === "datetime-local") {
                  el.value = formatFechaParaInput(fecha, true);
              } else {
                  el.value = val ?? "";
              }
          } else {
              el.value = val ?? "";
          }
      };
      
      if (d.tipoProceso) {
          selTipo.value = d.tipoProceso;
          poblarJuzgadosPorTipo(d.tipoProceso);
      }
      
      ["numCausa", "caratula", "tipoProceso", "juzgado", "intervencion", "datosNnya", "usuarioAsignado", "estado", "prioridad", "recursos", "recursosContestacion", "estadoRecursos", "nnyaGesell", "observaciones"].forEach(k => setVal(k, d[k]));
      ["fechaInicio", "fechaPase", "vencimiento", "vencimientoRecursos", "audienciaGesell"].forEach(k => setVal(k, d[k]));
      
      const hayRecursos = !!d.recursos;
      $("recursos-opcionales").style.display = hayRecursos ? "block" : "none";
      
      audienciasContainer.innerHTML = "";
      if (Array.isArray(d.audiencias) && d.audiencias.length > 0) {
          d.audiencias.forEach(aud => {
              const fecha = toDate(aud);
              if (fecha) {
                  audienciasContainer.appendChild(crearAudienciaItem(formatFechaParaInput(fecha, true)));
              }
          });
      } else {
          agregarAudiencia();
      }
      
      const habilitar = !!(d.audienciaGesell || d.nnyaGesell);
      $("habilitarAudienciaGesell").checked = habilitar;
      toggleGesell(habilitar);
  }

  function crearAudienciaItem(value = "") {
    const item = document.createElement('div');
    item.className = 'audiencia-item';
    item.innerHTML = `<input type="datetime-local" value="${value}"><button type="button" class="btn-eliminar-audiencia"><i class="fa fa-trash"></i></button>`;
    const eliminarBtn = item.querySelector('.btn-eliminar-audiencia');
    eliminarBtn.onclick = function() { 
        if (audienciasContainer.children.length > 1) {
            item.remove(); 
        } else {
            mostrarAlertaPersonalizada("Error", "Debe haber al menos una audiencia"); 
        }
    };
    return item;
  }
  
  function agregarAudiencia() { 
      audienciasContainer.appendChild(crearAudienciaItem()); 
  }
  
  btnAgregarAudiencia.onclick = agregarAudiencia;
  
  window.addEventListener("click", e=>{ 
      if (e.target === modal) modal.style.display="none"; 
      if (e.target === modalVer) modalVer.style.display="none"; 
      if (e.target === confirmModal) confirmModal.style.display="none";
      if (e.target === alertModal) alertModal.style.display="none";
  });
  
  let modo = "nuevo";
  
  // Inicialización de la aplicación
  async function initApp() {
      try {
          await Promise.all([cargarUsuarios(), cargarJuzgados()]);
          
          poblarFiltroUsuarios();
          poblarTiposProceso();
          poblarSelectUsuarios();
          
          suscribirCausas();
      } catch (error) {
          console.error("Error durante la inicialización:", error);
          mostrarAlertaPersonalizada("Error de Carga", "Error al cargar los datos iniciales. Verifica la consola para más detalles.");
      }
  }

  if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
  } else {
      initApp();
  }
  </script>
</body>
</html>
